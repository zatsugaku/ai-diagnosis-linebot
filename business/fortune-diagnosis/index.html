<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è¨ºæ–­ã‚¢ãƒ—ãƒªï½œãƒ•ã‚©ãƒ¼ãƒãƒ¥ãƒ³è¨ºæ–­</title>
  <style>
    :root { --radius: 16px; }
    * { box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif; margin: 0; background: #f7f7f8; color: #111; }
    .container { max-width: 820px; margin: 28px auto; padding: 0 16px 56px; }
    header { text-align: center; margin-bottom: 18px; }
    h1 { font-size: 22px; margin: 0 0 6px; }
    .sub { color: #666; font-size: 13px; }

    .card { background: #fff; border-radius: var(--radius); box-shadow: 0 4px 20px rgba(0,0,0,.06); padding: 18px; }
    .hidden { display: none !important; }

    /* Progress */
    .progress { display: flex; align-items: center; gap: 12px; margin: 14px 0 16px; }
    .bar { position: relative; flex: 1; height: 8px; background: #eee; border-radius: 999px; overflow: hidden; }
    .bar > i { position: absolute; inset: 0; width: 0%; background: #111; opacity: .12; }
    .progress small { color: #555; }

    /* Question */
    #question-card { margin-top: 10px; }
    #question-text { font-size: 18px; font-weight: 600; line-height: 1.6; }
    #options { display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 14px; }
    .opt { display: flex; align-items: center; justify-content: space-between; gap: 8px; padding: 12px 14px; border-radius: 12px; border: 1px solid #e5e7eb; background: #fff; cursor: pointer; transition: transform .02s ease, border-color .12s ease; }
    .opt:hover { border-color: #d1d5db; }
    .opt:active { transform: translateY(1px); }
    .opt span { pointer-events: none; }

    /* Feedback */
    .feedback { border: 1px dashed #e5e7eb; background: #fafafa; margin-top: 12px; }
    .feedback .feedback-title { font-size: 14px; font-weight: 700; margin-bottom: 4px; }
    .feedback .feedback-content { font-size: 14px; color: #333; white-space: pre-wrap; }

    /* Nav */
    #nav { display: flex; align-items: center; justify-content: space-between; margin-top: 16px; gap: 10px; }
    .btn { padding: 10px 14px; border-radius: 12px; border: 1px solid #e5e7eb; background: #fff; cursor: pointer; font-weight: 600; }
    .btn[disabled] { opacity: .4; cursor: not-allowed; }
    .btn.primary { background: #111; color: #fff; border-color: #111; }

    /* Style controls */
    #style-controls { display: none; margin-top: 10px; text-align: center; }
    #style-controls label { margin-right: 12px; }

    /* Result */
    #result { margin-top: 18px; }
    #result h2 { font-size: 18px; margin: 0 0 8px; }
    #ai-output { white-space: pre-wrap; line-height: 1.7; }
    .row { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .pill { font-size: 12px; padding: 4px 8px; background: #f0f0f2; border-radius: 999px; }
    .muted { color: #666; }

    footer { text-align: center; color: #888; font-size: 12px; margin-top: 28px; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ãƒ•ã‚©ãƒ¼ãƒãƒ¥ãƒ³è¨ºæ–­</h1>
      <div class="sub">8å•ã«ç­”ãˆã‚‹ã ã‘ã§ã€ã‚ãªãŸã®ã‚¿ã‚¤ãƒ—ã‚’AIãŒåˆ†æã—ã¾ã™ã€‚</div>
    </header>

    <div id="app" class="card">
      <div class="progress">
        <small id="progress-text" aria-live="polite">æº–å‚™ä¸­â€¦</small>
        <div class="bar" aria-hidden="true"><i id="bar-fill"></i></div>
      </div>

      <div id="question-card" class="card" style="padding:16px;">
        <div id="question-text">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
        <div id="options" aria-live="polite"></div>
        <div id="feedback" class="card feedback hidden">
          <div class="feedback-title"></div>
          <div class="feedback-content"></div>
        </div>
      </div>

      <div id="nav">
        <button id="prev" class="btn" type="button">â† å‰ã¸</button>
        <div class="row">
          <button id="analyze" class="btn primary" type="button">AIã«åˆ†æã—ã¦ã‚‚ã‚‰ã†</button>
          <button id="next" class="btn" type="button">æ¬¡ã¸ â†’</button>
        </div>
      </div>

      <!-- æ–‡é‡/çµµæ–‡å­—ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ï¼ˆæœ€çµ‚å•ã«åˆ°é”å¾Œã«è¡¨ç¤ºï¼‰ -->
      <div id="style-controls">
        <label>æ–‡é‡ï¼š
          <select id="verbosity">
            <option value="short">çŸ­ã‚</option>
            <option value="standard" selected>æ¨™æº–</option>
            <option value="long">è©³ã—ã‚</option>
          </select>
        </label>
        <label><input type="checkbox" id="emoji" checked> çµµæ–‡å­—ã‚ã‚Š</label>
      </div>

      <section id="result" class="hidden">
        <h2>è¨ºæ–­çµæœ</h2>
        <div class="row" style="margin-bottom:6px;">
          <span id="result-type" class="pill"></span>
          <span id="result-score" class="pill"></span>
        </div>
        <div id="ai-output" class="card" style="padding:14px;"></div>
        <div class="row" style="margin-top:12px;">
          <button id="copy" class="btn" type="button">çµæœã‚’ã‚³ãƒ”ãƒ¼</button>
          <button id="restart" class="btn" type="button">ã‚‚ã†ä¸€åº¦è¨ºæ–­</button>
        </div>
      </section>
    </div>

    <footer>Â© 2025 Fortune Diagnosis</footer>
  </div>

  <!-- å¤–éƒ¨è¨­å®šï¼ˆè³ªå•/ã‚¿ã‚¤ãƒ—å®šç¾©ï¼‰ -->
  <script src="/business/fortune-diagnosis/fortune_questions_config.js"></script>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
  <script>
    'use strict';

    /** ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ **/
    const $ = (sel) => document.querySelector(sel);
    const create = (tag, props = {}, ...children) => {
      const el = document.createElement(tag);
      Object.entries(props).forEach(([k, v]) => {
        if (k === 'class') el.className = v;
        else if (k === 'dataset') Object.assign(el.dataset, v);
        else if (k in el) el[k] = v; else el.setAttribute(k, v);
      });
      for (const child of children) {
        if (child == null) continue;
        if (typeof child === 'string' || typeof child === 'number') el.appendChild(document.createTextNode(String(child)));
        else el.appendChild(child);
      }
      return el;
    };

    const sessionId = (() =>
      (crypto?.randomUUID?.() || Math.random().toString(36).slice(2)) + '-' + Date.now())();

    /** è³ªå•/ã‚¿ã‚¤ãƒ—è¨­å®šã®æ¤œè¨¼ **/
    function ensureConfigLoaded() {
      const qData = (window.QUESTION_DATA || window.FORTUNE_QUESTION_DATA || []);
      if (!Array.isArray(qData) || qData.length === 0) {
        throw new Error('è³ªå•ãƒ‡ãƒ¼ã‚¿ï¼ˆQUESTION_DATAï¼‰ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å¤–éƒ¨JSã®ãƒ‘ã‚¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
      }
      const types = (window.FORTUNE_TYPES || []);
      if (!Array.isArray(types) || types.length === 0) {
        console.warn('FORTUNE_TYPES ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚¹ã‚³ã‚¢å¸¯â†’ã‚¿ã‚¤ãƒ—ã®å‰²å½“ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæŒ™å‹•ã«ãªã‚Šã¾ã™ã€‚');
      }
      return { qData, types };
    }

    /** ã‚¹ã‚³ã‚¢å¸¯ã‹ã‚‰ã‚¿ã‚¤ãƒ—ã‚’æ±ºå®šï¼ˆæŸ”è»Ÿå¯¾å¿œï¼‰ **/
    function determineType(totalScore, types) {
      if (!Array.isArray(types) || types.length === 0) {
        return { name: 'ã‚¿ã‚¤ãƒ—A', description: '', min: -Infinity, max: Infinity };
      }
      const norm = types.map(t => {
        const min = (Number.isFinite(t.min) ? t.min : (Number.isFinite(t.minScore) ? t.minScore : -Infinity));
        const max = (Number.isFinite(t.max) ? t.max : (Number.isFinite(t.maxScore) ? t.maxScore : Infinity));
        return { ...t, min, max };
      });
      const inRange = norm.find(t => totalScore >= t.min && totalScore <= t.max);
      if (inRange) return inRange;
      // è¿‘ã„min/maxã§æ±ºå®š
      let best = norm[0], bestDist = Infinity;
      for (const t of norm) {
        const dist = (totalScore < t.min) ? (t.min - totalScore) : (totalScore - t.max);
        if (dist < bestDist) { best = t; bestDist = dist; }
      }
      return best;
    }

    class DiagnosisSystem {
      constructor(config) {
        this.questionData = config.qData;
        this.types = config.types;
        this.currentQuestion = 0;
        this.answers = []; // indexé…åˆ—
        this.totalScore = 0;
        this.sessionId = sessionId;

        // UIè¦ç´ 
        this.progressText = $('#progress-text');
        this.barFill = $('#bar-fill');
        this.qText = $('#question-text');
        this.optionsEl = $('#options');
        this.feedbackEl = $('#feedback');
        this.feedbackTitle = this.feedbackEl.querySelector('.feedback-title');
        this.feedbackContent = this.feedbackEl.querySelector('.feedback-content');
        this.prevBtn = $('#prev');
        this.nextBtn = $('#next');
        this.analyzeBtn = $('#analyze');
        this.styleControls = $('#style-controls');
        this.verbosityEl = $('#verbosity');
        this.emojiEl = $('#emoji');
        this.resultSec = $('#result');
        this.resultType = $('#result-type');
        this.resultScore = $('#result-score');
        this.aiOutput = $('#ai-output');
        this.copyBtn = $('#copy');
        this.restartBtn = $('#restart');

        this.bind();
        this.render();
      }

      bind() {
        this.prevBtn.addEventListener('click', () => this.goto(this.currentQuestion - 1));
        this.nextBtn.addEventListener('click', () => this.goto(this.currentQuestion + 1));
        this.analyzeBtn.addEventListener('click', () => this.onAnalyze());
        this.copyBtn.addEventListener('click', () => this.copyResult());
        this.restartBtn.addEventListener('click', () => this.restart());
      }

      restart() {
        this.currentQuestion = 0;
        this.answers = [];
        this.totalScore = 0;
        this.resultSec.classList.add('hidden');
        this.styleControls.style.display = 'none';
        this.render();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      goto(index) {
        if (index < 0 || index >= this.questionData.length) return;
        this.currentQuestion = index;
        this.render();
      }

      render() {
        const q = this.questionData[this.currentQuestion];
        // é€²æ—
        const total = this.questionData.length;
        const answeredCount = this.answers.filter(v => v !== undefined).length;
        this.progressText.textContent = `è³ªå• ${this.currentQuestion + 1} / ${total}`;
        const fillPct = Math.max(0, Math.min(100, Math.round((answeredCount / total) * 100)));
        this.barFill.style.width = fillPct + '%';

        // è³ªå•æ–‡
        this.qText.textContent = (q && (q.text ?? q.title ?? 'è³ªå•'));

        // é¸æŠè‚¢æç”»ï¼ˆXSSå¯¾ç­–: textContentã§æŒ¿å…¥ï¼‰
        this.optionsEl.replaceChildren();
        const opts = Array.isArray(q?.options) ? q.options : [];
        opts.forEach((label, idx) => {
          const btn = create('button', { class: 'opt', type: 'button', dataset: { idx } },
            create('span', {}, String(label))
          );
          btn.addEventListener('click', () => this.selectOption(idx));
          this.optionsEl.appendChild(btn);
        });

        // æ—¢å­˜å›ç­”ã®å¼·èª¿ï¼ˆã‚ã‚Œã°ï¼‰
        const selected = this.answers[this.currentQuestion];
        if (Number.isInteger(selected)) {
          const b = this.optionsEl.querySelector(`.opt[data-idx="${selected}"]`);
          if (b) b.style.borderColor = '#111';
        }

        // ç›´è¿‘ã®çµ±åˆãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤ºï¼ˆè©²å½“æ™‚ï¼‰
        this.updateFeedback();

        // ãƒŠãƒ“ã®æ›´æ–°
        this.updateNavigation();
      }

      updateFeedback() {
        const q = this.questionData[this.currentQuestion];
        const selected = this.answers[this.currentQuestion];
        const fb = Array.isArray(q?.feedbacks) && Number.isInteger(selected) ? q.feedbacks[selected] : null;
        if (fb && (fb.title || fb.content)) {
          this.feedbackTitle.textContent = fb.title || '';
          this.feedbackContent.textContent = fb.content || '';
          this.feedbackEl.classList.remove('hidden');
        } else {
          this.feedbackEl.classList.add('hidden');
        }
      }

      updateNavigation() {
        const total = this.questionData.length;
        const atFirst = this.currentQuestion === 0;
        const atLast = this.currentQuestion === total - 1;
        const answered = Number.isInteger(this.answers[this.currentQuestion]);

        this.prevBtn.disabled = atFirst;
        this.nextBtn.disabled = atLast || !answered;
        this.analyzeBtn.disabled = !(atLast && answered);

        // æœ€çµ‚å•ã«å›ç­”æ¸ˆã¿ â†’ ã‚¹ã‚¿ã‚¤ãƒ«ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’è¡¨ç¤º
        this.styleControls.style.display = (atLast && answered) ? 'block' : 'none';
      }

      selectOption(optionIndex) {
        const q = this.questionData[this.currentQuestion];
        const amounts = Array.isArray(q?.amounts) ? q.amounts : [];
        const amount = Number.isFinite(amounts[optionIndex]) ? Number(amounts[optionIndex]) : 0;

        // ä»¥å‰ã®é¸æŠã‚’å·®ã—æˆ»ã™ï¼ˆå†é¸æŠæ™‚ã®åˆè¨ˆèª¿æ•´ï¼‰
        const prev = this.answers[this.currentQuestion];
        if (Number.isFinite(prev)) {
          const prevAmt = Number.isFinite(amounts[prev]) ? Number(amounts[prev]) : 0;
          this.totalScore -= prevAmt;
        }

        this.answers[this.currentQuestion] = optionIndex;
        this.totalScore += amount;

        // è¦‹ãŸç›®æ›´æ–°
        this.optionsEl.querySelectorAll('.opt').forEach(el => el.style.borderColor = '#e5e7eb');
        const picked = this.optionsEl.querySelector(`.opt[data-idx="${optionIndex}"]`);
        if (picked) picked.style.borderColor = '#111';

        // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
        this.updateFeedback();

        // ã™ãã«æ¬¡ã¸ï¼ˆUX: ä»»æ„ã€‚å›ºå®šã«ã—ãŸã„å ´åˆã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼‰
        if (this.currentQuestion < this.questionData.length - 1) {
          this.goto(this.currentQuestion + 1);
        } else {
          this.updateNavigation();
        }
      }

      determineFortuneType() {
        return determineType(this.totalScore, this.types);
      }

      async onAnalyze() {
        this.analyzeBtn.disabled = true;
        this.analyzeBtn.textContent = 'åˆ†æä¸­â€¦';
        try {
          const analysis = await this.callAIAnalysis();
          this.showResult(analysis);
        } catch (err) {
          console.error(err);
          const fallback = this.displayOfflineAnalysis();
          this.showResult(fallback, true);
        } finally {
          this.analyzeBtn.textContent = 'AIã«åˆ†æã—ã¦ã‚‚ã‚‰ã†';
          this.updateNavigation();
        }
      }

      async callAIAnalysis() {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000);

        const verbosity = this.verbosityEl ? this.verbosityEl.value : 'standard';
        const emoji = this.emojiEl ? !!this.emojiEl.checked : true;
        const fType = this.determineFortuneType();

        const payload = {
          answers: this.answers,
          totalScore: this.totalScore,
          fortuneType: fType?.name || '',
          timestamp: new Date().toISOString(),
          options: { verbosity, emoji }
        };

        const res = await fetch('/api/fortune-analyze', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-Session-Id': this.sessionId },
          body: JSON.stringify(payload),
          signal: controller.signal
        });
        clearTimeout(timeoutId);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        if (!data || data.success === false) throw new Error(data?.error || 'AIåˆ†æå¤±æ•—');
        return data.analysis;
      }

      displayOfflineAnalysis() {
        const type = this.determineFortuneType();
        const emoji = this.emojiEl ? !!this.emojiEl.checked : true;
        const face = emoji ? 'ğŸ”®' : '';
        const lines = [];
        lines.push(`${face} ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ç°¡æ˜“åˆ†æ`);
        lines.push(`ã‚¿ã‚¤ãƒ—: ${type?.name ?? 'N/A'}`);
        lines.push(`ã‚¹ã‚³ã‚¢: ${this.totalScore}`);
        if (type?.description) lines.push(`ç‰¹å¾´: ${type.description}`);
        lines.push('');
        lines.push('â€» ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã®ãŸã‚ã€ç°¡æ˜“ç‰ˆã®çµæœã§ã™ã€‚é€šä¿¡ç’°å¢ƒã‚’ã”ç¢ºèªã®ã†ãˆå†å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚');
        return lines.join('
');
      }

      showResult(analysis, isFallback = false) {
        const type = this.determineFortuneType();
        this.resultType.textContent = `ã‚¿ã‚¤ãƒ—: ${type?.name ?? 'N/A'}`;
        this.resultScore.textContent = `ã‚¹ã‚³ã‚¢: ${this.totalScore}`;

        // analysis ã¯ string / object ã®ä¸¡å¯¾å¿œ
        let text = '';
        if (typeof analysis === 'string') {
          text = analysis;
        } else if (analysis && typeof analysis === 'object') {
          const parts = [];
          if (analysis.title) parts.push(`ã€${analysis.title}ã€‘`);
          if (analysis.summary) parts.push(String(analysis.summary));
          if (Array.isArray(analysis.points)) {
            parts.push('', ...analysis.points.map((p, i) => `${i + 1}. ${p}`));
          }
          if (analysis.advice) {
            parts.push('', `ã‚¢ãƒ‰ãƒã‚¤ã‚¹: ${analysis.advice}`);
          }
          text = parts.join('\n');
        } else {
          text = String(analysis ?? '');
        }

        this.aiOutput.textContent = text;
        this.resultSec.classList.remove('hidden');
        if (isFallback) this.resultSec.classList.add('fallback');
        this.resultSec.scrollIntoView({ behavior: 'smooth' });
      }

      copyResult() {
        const text = this.aiOutput.textContent || '';
        if (!text) return;
        navigator.clipboard?.writeText(text).then(() => {
          this.copyBtn.textContent = 'ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ';
          setTimeout(() => (this.copyBtn.textContent = 'çµæœã‚’ã‚³ãƒ”ãƒ¼'), 1200);
        }).catch(() => {
          // éå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶
          const textarea = create('textarea', { style: 'position:fixed;left:-9999px;top:-9999px;' }, text);
          document.body.appendChild(textarea);
          textarea.select();
          document.execCommand('copy');
          textarea.remove();
        });
      }
    }

    // èµ·å‹•
    (function bootstrap() {
      try {
        const config = ensureConfigLoaded();
        window.__app = new DiagnosisSystem(config);
      } catch (e) {
        console.error(e);
        const app = $('#app');
        app.replaceChildren(
          create('div', { class: 'card', style: 'background:#fff3f3;color:#b00020;' },
            create('div', { style: 'font-weight:700;margin-bottom:6px;' }, 'èµ·å‹•ã‚¨ãƒ©ãƒ¼'),
            create('div', {}, String(e.message || e))
          )
        );
      }
    })();
  </script>
</body>
</html>
